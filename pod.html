<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stylit Pod</title>
  <style>
    :root{
      --bg:#0b0b0f; --card:#121218; --muted:#9aa0a6; --text:#fff;
      --border: rgba(255,255,255,.12);
      --btn:#1f1f28;
      --btn2:#ffffff;
      --btn2Text:#000;
      --danger:#ff4d4d;
      --ok:#22c55e;
    }
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);}
    .wrap{max-width:560px;margin:0 auto;padding:18px 14px 40px;}
    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.35);}
    .img{width:100%;aspect-ratio:1/1;background:#1b1b24;display:flex;align-items:center;justify-content:center;}
    .img img{width:100%;height:100%;object-fit:cover;display:none;}
    .pad{padding:14px;}
    h1{font-size:20px;margin:0 0 6px;}
    .meta{color:var(--muted);font-size:13px;line-height:1.35}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;}
    .btn{
      flex:1; min-width:120px;
      background:var(--btn); color:#fff;
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px 10px;
      font-weight:700;
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;gap:10px;
    }
    .btn:disabled{opacity:.45;cursor:not-allowed}
    .btnPrimary{background:var(--btn2);color:var(--btn2Text);border-color:rgba(255,255,255,.2)}
    .field{margin-top:12px;}
    label{display:block;font-size:13px;color:var(--muted);margin:0 0 6px;}
    input,textarea{
      width:100%;
      background:rgba(255,255,255,.06);
      color:#fff;
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px 12px;
      font-size:15px;
      outline:none;
      box-sizing:border-box;
    }
    textarea{min-height:90px;resize:vertical}
    .status{margin-top:12px;color:var(--muted);font-size:13px}
    .err{color:var(--danger);margin-top:10px;font-size:13px;white-space:pre-wrap}
    .ok{color:var(--ok)}
    .footer{margin-top:14px;padding:14px;border:1px solid var(--border);border-radius:18px;background:rgba(255,255,255,.04)}
    .small{color:var(--muted);font-size:12px;line-height:1.4}
    a{color:#fff}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="img" id="imgBox">
        <img id="podImg" alt="Pod image" />
        <div id="imgPlaceholder" style="color:rgba(255,255,255,.55);font-weight:700;">Loading image‚Ä¶</div>
      </div>

      <div class="pad">
        <h1 id="title">Loading pod‚Ä¶</h1>
        <div class="meta" id="meta">Fetching details.</div>

        <div class="field" id="nameField">
          <label for="guestName">Your name <span style="opacity:.6">(required for friends pods)</span></label>
          <input id="guestName" placeholder="e.g., Alex" />
        </div>

        <div class="field" id="commentField" style="display:none;">
          <label for="guestComment">Comment <span style="opacity:.6">(friends pods)</span></label>
          <textarea id="guestComment" placeholder="Tell your friend what you think‚Ä¶"></textarea>
        </div>

        <div class="row">
          <button class="btn" id="btnYes">üî• Fire</button>
          <button class="btn" id="btnMaybe">ü§î Maybe</button>
          <button class="btn" id="btnNo">‚ùå No</button>
        </div>

        <div class="status" id="status"></div>
        <div class="err" id="err"></div>

        <div class="footer">
          <div class="row" style="margin-top:0;">
            <a class="btn btnPrimary" id="downloadBtn" href="download.html">Download Stylit</a>
          </div>
          <div class="small" style="margin-top:10px;">
            Tip: You can vote here quickly. Installing the app unlocks more features.
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  // ‚úÖ IMPORTANT: This must point to your Vercel API project
  const API_BASE = "https://mvp-styli.vercel.app";

  // ---- Helpers
  function qs(name){ return new URLSearchParams(location.search).get(name); }

  // Support both styles:
  // 1) /pod.html?podId=...
  // 2) /pod/<id>?from=...&aud=...
  function getPodIdFromUrl() {
    const direct = qs("podId");
    if (direct) return direct;

    const m = location.pathname.match(/\/pod\/([0-9a-fA-F-]{36})/);
    return m ? m[1] : null;
  }

  function normalizeAud(aud) {
    if (!aud) return "";
    const v = aud.toLowerCase();
    if (v === "friends") return "friends";
    if (v === "twins" || v === "style_twins") return "twins";
    if (v === "global" || v === "global_mix") return "global";
    return v;
  }

  function getOrCreateGuestId() {
    const key = "stylit_guest_id";
    let id = localStorage.getItem(key);
    if (!id) {
      id = "g_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
      localStorage.setItem(key, id);
    }
    return id;
  }

  // ---- State
  const podId = getPodIdFromUrl();
  const fromUserId = qs("from") || "";
  const aud = normalizeAud(qs("aud") || "");
  const guestId = getOrCreateGuestId();

  const elTitle = document.getElementById("title");
  const elMeta = document.getElementById("meta");
  const elImg = document.getElementById("podImg");
  const elImgPh = document.getElementById("imgPlaceholder");
  const elErr = document.getElementById("err");
  const elStatus = document.getElementById("status");
  const elNameField = document.getElementById("nameField");
  const elCommentField = document.getElementById("commentField");
  const elGuestName = document.getElementById("guestName");
  const elGuestComment = document.getElementById("guestComment");

  const btnYes = document.getElementById("btnYes");
  const btnMaybe = document.getElementById("btnMaybe");
  const btnNo = document.getElementById("btnNo");
  const downloadBtn = document.getElementById("downloadBtn");

  function setError(msg) { elErr.textContent = msg || ""; }
  function setStatus(msg, ok=false) {
    elStatus.textContent = msg || "";
    elStatus.className = ok ? "status ok" : "status";
  }
  function setLoadingButtons(loading) {
    [btnYes, btnMaybe, btnNo].forEach(b => b.disabled = !!loading);
  }

  async function fetchPod() {
    if (!podId) {
      setError("Missing podId in URL.");
      elTitle.textContent = "Could not load pod.";
      elMeta.textContent = "Invalid link.";
      return null;
    }

    const url = `${API_BASE}/api/pod-public?podId=${encodeURIComponent(podId)}`;
    console.log("Fetching pod from:", url);

    let res;
    try {
      res = await fetch(url, { cache: "no-store" });
    } catch (e) {
      setError("Network error loading pod.");
      return null;
    }

    const text = await res.text();
    console.log("pod-public status:", res.status, "body:", text);

    if (!res.ok) {
      setError("Could not load pod.\n\n" + text);
      return null;
    }

    try { return JSON.parse(text); }
    catch { setError("Bad JSON from API."); return null; }
  }

  function applyPod(pod) {
    elTitle.textContent = pod.title || "What do you think?";
    const ends = pod.ends_at ? new Date(pod.ends_at) : null;
    const live = !!pod.isLive;
    const audience = pod.audience || aud || "";

    elMeta.textContent =
      `Audience: ${audience} ‚Ä¢ Status: ${live ? "Live" : (pod.status || "unknown")} ‚Ä¢ Ends: ${ends ? ends.toLocaleString() : "‚Äî"}`;

    // show comment field only for friends
    const isFriends = (aud === "friends") || (pod.audience === "friends");
    elCommentField.style.display = isFriends ? "block" : "none";
    elNameField.querySelector("span")?.remove;
    // keep name input visible always, but required only for friends
    if (isFriends) {
      elNameField.querySelector("label").innerHTML = 'Your name <span style="opacity:.6">(required)</span>';
    } else {
      elNameField.querySelector("label").innerHTML = 'Your name <span style="opacity:.6">(optional)</span>';
    }

    if (pod.image_url) {
      elImg.src = pod.image_url;
      elImg.onload = () => { elImg.style.display = "block"; elImgPh.style.display = "none"; };
      elImg.onerror = () => { elImgPh.textContent = "Could not load image."; };
    } else {
      elImgPh.textContent = "No image.";
    }

    // Download button keeps ref so you can track
    const dl = `download.html${fromUserId ? `?from=${encodeURIComponent(fromUserId)}` : ""}`;
    downloadBtn.href = dl;

    if (!live) {
      setStatus("This pod has ended.", false);
      setLoadingButtons(true);
    } else {
      setStatus("", false);
    }
  }

  async function submitVote(choice) {
    setError("");
    setStatus("Submitting vote‚Ä¶");
    setLoadingButtons(true);

    const name = (elGuestName.value || "").trim();
    const comment = (elGuestComment.value || "").trim();

    // friends requires name
    const isFriends = (aud === "friends");
    if (isFriends && !name) {
      setError("Please enter your name to vote on a friends pod.");
      setLoadingButtons(false);
      setStatus("");
      return;
    }

    const payload = {
      podId,
      choice,                 // 'yes' | 'maybe' | 'no'
      guest_id: guestId,
      guest_name: name || null,
      guest_comment: (isFriends ? (comment || null) : null),
      from_user_id: fromUserId || null,
      aud: aud || null
    };

    const url = `${API_BASE}/api/pod-guest-vote`;
    console.log("Posting vote to:", url, payload);

    let res;
    try {
      res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
    } catch (e) {
      setError("Network error submitting vote.");
      setLoadingButtons(false);
      setStatus("");
      return;
    }

    const text = await res.text();
    console.log("pod-guest-vote status:", res.status, "body:", text);

    if (!res.ok) {
      setError("Vote failed.\n\n" + text);
      setLoadingButtons(false);
      setStatus("");
      return;
    }

    setStatus("‚úÖ Vote submitted! Redirecting‚Ä¶", true);

    // After vote: send to download page (with tracking params)
    const next = `download.html?from=${encodeURIComponent(fromUserId || "")}&podId=${encodeURIComponent(podId)}&aud=${encodeURIComponent(aud || "")}&voted=1`;
    setTimeout(() => { window.location.href = next; }, 900);
  }

  // Wire buttons
  btnYes.onclick = () => submitVote("yes");
  btnMaybe.onclick = () => submitVote("maybe");
  btnNo.onclick = () => submitVote("no");

  // Init
  (async function init() {
    const pod = await fetchPod();
    if (!pod) {
      elTitle.textContent = "Could not load pod.";
      elMeta.textContent = "Load failed.";
      setLoadingButtons(true);
      return;
    }
    applyPod(pod);
  })();
</script>
</body>
</html>
